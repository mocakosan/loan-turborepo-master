<!doctype html>
<html lang="ko">
  <head>
    <!-- meta -->
    <%- include("../layout/meta") %>

    <link rel="stylesheet" href="/assets/css/default.css" />
    <link rel="stylesheet" href="/assets/css/sub.css" />
    <link rel="stylesheet" href="/assets/css/service.css" />
  </head>
  <body>
    <!-- header -->
    <%- include("../layout/header") %>

    <!-- nav -->
    <%- include("../layout/mobile-nav") %>

    <!-- content -->
    <main id="content">
      <!-- global-search -->
      <%- include("../form/find-lender-by-region-form", { sido: "", search: "" }) %>

      <!-- sub-layout -->
      <section class="sub-layout">
        <div class="container">
          <nav class="lnb">
            <div class="lnb-header">
              <small>대출업체가 모두 한 곳에, 추천대출!</small>
              <strong>고객센터</strong>
            </div>
            <div class="lnb-body">
              <ul>
                <li><a href="/service/notice_list">공지사항</a></li>
                <li class="active">
                  <a href="/service/one_inquiry">1:1 문의</a>
                </li>
                <li>
                  <a href="/service/advertising_inquiry">광고문의</a>
                </li>
              </ul>
            </div>
          </nav>
          <div class="sub-content">
            <article class="notice-list">
              <div class="article-header">
                <h3>1:1문의</h3>
              </div>
              <form id="inquiryForm" class="article-content">
                <!-- write-form -->
                <div class="write-form">
                  <ul>
                    <li>
                      <dl>
                        <dt class="essential">제목</dt>
                        <dd>
                          <div class="form-group">
                            <input
                              type="text"
                              name="title"
                              class="form-control"
                              placeholder="제목을 입력해주세요."
                            />
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">이름</dt>
                        <dd>
                          <div class="form-group name">
                            <input
                              type="text"
                              name="name"
                              class="form-control"
                              placeholder="이름"
                            />
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">문의유형</dt>
                        <dd>
                          <div class="form-group select">
                            <select class="form-control" name="inquiryKind">
                              <option value="">유형선택</option>

                              <% inquiryKinds.forEach((item) => { %>
                              <option value="<%= item.value %>">
                                <%= item.name %>
                              </option>
                              <% }) %>
                            </select>
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">휴대폰 번호</dt>
                        <dd class="phone">
                          <ul>
                            <li>
                              <div class="form-group">
                                <input
                                  type="text"
                                  name="phoneNumber1"
                                  class="form-control"
                                  placeholder="010"
                                  value="010"
                                />
                              </div>
                            </li>
                            <li>
                              <div class="form-group">
                                <input
                                  type="text"
                                  name="phoneNumber2"
                                  class="form-control"
                                  placeholder="0000"
                                />
                              </div>
                            </li>
                            <li>
                              <div class="form-group">
                                <input
                                  type="text"
                                  name="phoneNumber3"
                                  class="form-control"
                                  placeholder="0000"
                                />
                              </div>
                            </li>
                          </ul>
                          <div class="btn-area">
                            <button
                              class="btn-certification"
                              id="verifyPhoneButton"
                            >
                              인증번호 받기
                            </button>
                            >
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">인증번호</dt>
                        <dd class="confirm">
                          <div class="form-group">
                            <input
                              type="text"
                              name="verificationCode"
                              class="form-control"
                              placeholder="인증번호 확인"
                            />
                          </div>
                          <div class="btn-area">
                            <button class="btn-confirm" id="confirmCodeButton">
                              확인
                            </button>
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">문의내용</dt>
                        <dd>
                          <div class="form-group">
                            <textarea
                              class="form-control"
                              placeholder="운영시간 이후 접수건은 정상 영업일 기준 익일 순차대로 답변드립니다.&#13;운영시간 (평일 09:00 ~ 18:00 / 점심시간 12:00 ~ 13:00)&#13;※ 주말&공휴일 휴무"
                              name="content"
                            ></textarea>
                          </div>
                        </dd>
                      </dl>
                    </li>
                    <li>
                      <dl>
                        <dt class="essential">개인정보수집 및 이용동의</dt>
                        <dd>
                          <div class="check-area">
                            <input type="checkbox" id="check-agree" />
                            <label for="check-agree"
                              ><span class="icon"></span> 개인정보 이용 및
                              수집에 동의합니다. <small>(필수)</small>
                              <a href="#agree-pop" class="btn-modal"
                                >보기</a
                              ></label
                            >
                          </div>
                        </dd>
                      </dl>
                    </li>
                  </ul>
                </div>
                <div class="btn-area">
                  <div>
                    <button
                      type="button"
                      class="btn btn-cancel"
                      id="cancelButton"
                    >
                      취소하기
                    </button>
                    <button type="submit" class="btn btn-submit">
                      등록하기
                    </button>
                  </div>
                </div>
              </form>
            </article>
          </div>
        </div>
      </section>
    </main>

    <!-- modal-pop -->
    <div class="modal-backdrop"></div>
    <div class="modal-pop">
      <div class="modal agree-pop" id="agree-pop">
        <div class="modal-header">
          <h3>개인정보 수집 및 이용</h3>
          <button type="button" class="btn-modal-close">
            <img src="/assets/images/ico_modal_close.png" alt="" />
          </button>
        </div>
        <div class="modal-content agreement">
          <ul>
            <li>
              ■ 수집하는 개인정보의 필수항목 휴대폰번호, 비밀번호, 지역, 나이,
              직업(유/무), 성별, 대출희망금액, 대출상품종류(담보대출,신용대출),
              문의내용, 쿠키, 접속IP 정보
            </li>
            <li>
              ■ 개인정보의 수집 및 이용목적 이용자 요청 자료에 대한 무료
              대출상담 서비스에 응대
            </li>
            <li>
              ■ 책임사항 및 면책사항 작성 이후 진행과정에서 정보제공자(고객)와
              정보이용자(대출업체)간의 발생되는 문제는 고객의 동의에 의해 진행된
              것으로 모든 민형사상의 분쟁에서 추천대출는 어떠한 일체의 책임이
              없습니다. 자세한 사항은 이용약관을 의거 처리됩니다.
            </li>
            <li>
              ■ 개인정보의 보유 및 이용기간 원칙적으로 개인정보의 수집 및
              이용목적이 달성되면 지체 없이 파기합니다.<br />
              단, 상법/전자상거래 등에서의 소비자보호에 관한 법률 등 관계법령의
              규정에 의하여 보존할 필요가 있는 경우 회사는 관계법령에서 정한
              일정한 기간 동안 개인정보를 보관합니다.
            </li>
          </ul>
          <span class="attention">
            *귀하는 위 개인정보의 수집·이용에 대한 동의를 거부할 수 있으며, 동의
            후에도 언제든지 철회가능합니다.<br />
            다만 위 개인정보의 수집·이용에 동의하지 않을 경우 서비스 제공이 되지
            않는 등의 불이익을 받을 수 있습니다.
          </span>
        </div>
      </div>
    </div>

    <!-- terms-list -->
    <%- include("../layout/terms-list") %>

    <!-- quick-banner -->
    <%- include("../layout/quick-banner") %>

    <!-- footer -->
    <%- include("../layout/footer") %>

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="/assets/js/common.js"></script>
    <script src="/assets/js/sub.js"></script>

    <script>
      const form = document.getElementById('inquiryForm');

      // 인증번호 받기 버튼 이벤트
      const verifyPhoneButton = document.getElementById('verifyPhoneButton');
      verifyPhoneButton.addEventListener('click', (e) => {
        e.preventDefault();

        const formData = new FormData(form);

        const phoneNumber1 = formData.get('phoneNumber1');
        const phoneNumber2 = formData.get('phoneNumber2');
        const phoneNumber3 = formData.get('phoneNumber3');

        const phoneNumber = `${phoneNumber1}${phoneNumber2}${phoneNumber3}`;

        // 휴대폰 번호 유효성 검사 (010-XXXX-XXXX 또는 010XXXXXXXX 형식)
        const phoneRegex = /^(010-\d{4}-\d{4}|010\d{8})$/;
        if (!phoneNumber || !phoneRegex.test(phoneNumber)) {
          return alert('올바른 휴대폰 번호를 입력해주세요.');
        }

        fetch('/service/one_inquiry/send-verification', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phoneNumber: phoneNumber.replace(/\D/g, '') }),
        })
          .then(async (response) => {
            const json = await response.json();

            if (response.status !== 200) {
              throw new Error(json.message);
            }

            return json;
          })
          .then((data) => {
            alert('인증번호가 발송되었습니다.');
          })
          .catch((error) => {
            alert(error.message || '인증번호 발송에 실패했습니다.');
          });
      });

      let isPhoneVerified = false; // 인증 완료 상태 변수

      // 번호확인 버튼 이벤트
      const confirmCodeButton = document.getElementById('confirmCodeButton');
      confirmCodeButton.addEventListener('click', (e) => {
        e.preventDefault();

        const formData = new FormData(form);
        const phoneNumber1 = formData.get('phoneNumber1');
        const phoneNumber2 = formData.get('phoneNumber2');
        const phoneNumber3 = formData.get('phoneNumber3');

        const phoneNumber = `${phoneNumber1}${phoneNumber2}${phoneNumber3}`;
        const verificationCode = formData.get('verificationCode');

        if (!phoneNumber.length) {
          return alert('전화번호를 입력해주세요.');
        }

        if (!verificationCode.length) {
          return alert('인증번호를 입력해주세요.');
        }

        fetch('/service/one_inquiry/verify-code', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phoneNumber: phoneNumber.replace(/\D/g, ''),
            verificationCode,
          }),
        })
          .then(async (response) => {
            const json = await response.json();

            if (response.status !== 200) {
              throw new Error(json.message);
            }

            return json;
          })
          .then((data) => {
            isPhoneVerified = true; // 인증 완료
            verifyPhoneButton.disabled = true; // 인증번호 받기 버튼 비활성화
            confirmCodeButton.disabled = true;
            document.querySelector('input[name="phoneNumber1"]').readOnly =
              true;
            document.querySelector('input[name="phoneNumber2"]').readOnly =
              true;
            document.querySelector('input[name="phoneNumber3"]').readOnly =
              true;

            alert('인증이 완료되었습니다.');
          })
          .catch((error) => {
            alert(error.message || '인증번호가 올바르지 않습니다.');
          });
      });

      // 취소 버튼 클릭 이벤트
      const cancelButton = document.getElementById('cancelButton');
      cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        window.history.back();
      });

      // 등록하기 버튼 클릭 이벤트
      form.addEventListener('submit', function (e) {
        e.preventDefault(); // 기본 제출 막기 (페이지 이동 막음)

        if (!isPhoneVerified) {
          return alert('휴대폰 본인인증을 완료해주세요.');
        }

        const formData = new FormData(form);

        const title = formData.get('title');
        const name = formData.get('name');
        const inquiryKind = formData.get('inquiryKind');
        const phoneNumber1 = formData.get('phoneNumber1');
        const phoneNumber2 = formData.get('phoneNumber2');
        const phoneNumber3 = formData.get('phoneNumber3');
        const content = formData.get('content');

        const isCheckAgree = document.querySelector('#check-agree');

        if (!title.length) {
          return alert('제목을 입력해주세요.');
        }

        if (!name.length) {
          return alert('이름을 입력해주세요.');
        }

        if (!inquiryKind.length) {
          return alert('문의유형을 선택해주세요.');
        }

        if (
          !phoneNumber1.length ||
          !phoneNumber2.length ||
          !phoneNumber3.length
        ) {
          return alert('휴대폰 번호를 입력해주세요.');
        }

        if (!content.length) {
          return alert('문의내용을 입력해주세요.');
        }

        if (!isCheckAgree.checked) {
          return alert('개인정보수집 및 이용동의는 필수 항목입니다.');
        }

        const body = {
          title,
          name,
          inquiryKind,
          phoneNumber: `${phoneNumber1}${phoneNumber2}${phoneNumber3}`,
          content,
        };
        console.log({ body });

        fetch('/service/one_inquiry', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(body),
        })
          .then(async (response) => {
            const json = await response.json();

            if (response.status !== 201) {
              throw new Error(json.message);
            }

            return json;
          })
          .then((data) => {
            console.info('서버 응답:', data);
            form.reset();
            alert('등록을 완료했습니다.');
          })
          .catch((error) => {
            console.error('에러 발생:', error);
            alert(error?.message || '등록을 실패하였습니다.');
          });
      });
    </script>
  </body>
</html>
